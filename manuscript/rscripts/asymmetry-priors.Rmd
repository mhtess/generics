---
title: "asymmetry-priors"
author: "mht"
date: "August 12, 2015"
output: html_document
---
Priors
```{r helpers}
estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}
HPDhi<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}
HPDlo<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}

```



By Item

```{r priors2.byItem}
d1<-read.csv("~/Documents/research/generics/manuscript/model-results/generics-asym-priorByItem-incrmh100000_burn50000a.csv")
d2<-read.csv("~/Documents/research/generics/manuscript/model-results/generics-asym-priorByItem-incrmh100000_burn50000b.csv")
d3<-read.csv("~/Documents/research/generics/manuscript/model-results/generics-asym-priorByItem-incrmh100000_burn50000c.csv")

samples = 50000
d<-bind_rows(d1,d2,d3)




d.tidy <- d

# d.tidy <- d.tidy %>%
#   unite(a, Item, Prevalence) %>%
#   rename(Item = Parameter,
#          Prevalence = a)

d.params<-data.frame(Parameter = rep(d.tidy$Parameter, 
                               1+samples*d.tidy$Probability),
                     Item = rep(d.tidy$Item, 
                               1+samples*d.tidy$Probability),
                Prevalence = rep(d.tidy$Prevalence, 
                               1+samples*d.tidy$Probability),
                Response = rep(d.tidy$Value, 
                               1+samples*d.tidy$Probability))

# ggplot(d.params, aes(x=Response))+
#   geom_histogram()+
#   facet_grid(Item~Prevalence,scales='free')


  


d.summary<-d.params %>% group_by(Parameter,Item, Prevalence) %>%
  summarise(MAP = estimate_mode(Response),
            credHi = HPDhi(Response),
            credLo = HPDlo(Response))


ggplot(data=d.summary, aes(x=Parameter, y = MAP))+
  geom_bar(stat='identity', position=position_dodge())+
  geom_errorbar(aes(ymin=credLo, ymax=credHi))+
  facet_grid(Prevalence~Item, scales='free')


d.out <- d.summary %>% filter(Prevalence == 'gamma')

write.csv(d.out, file='~/Documents/research/generics/manuscript/model-results/asym-prior-byItem-gammaCIs.csv')

```

By Type

```{r priors.byType}
d1<-read.csv("~/Documents/research/generics/manuscript/model-results/generics-asym-prior-incrmh100000a.csv")
d2<-read.csv("~/Documents/research/generics/manuscript/model-results/generics-asym-prior-incrmh100000b.csv")
d3<-read.csv("~/Documents/research/generics/manuscript/model-results/generics-asym-prior-incrmh100000c.csv")

samples = 50000
d<-bind_rows(d1,d2,d3)




d.tidy <- d

# d.tidy <- d.tidy %>%
#   unite(a, Item, Prevalence) %>%
#   rename(Item = Parameter,
#          Prevalence = a)

d.params<-data.frame(Parameter = rep(d.tidy$Parameter, 
                               1+samples*d.tidy$Probability),
                     Item = rep(d.tidy$Item, 
                               1+samples*d.tidy$Probability),
                Prevalence = rep(d.tidy$Prevalence, 
                               1+samples*d.tidy$Probability),
                Response = rep(d.tidy$Value, 
                               1+samples*d.tidy$Probability))

# ggplot(d.params, aes(x=Response))+
#   geom_histogram()+
#   facet_grid(Item~Prevalence,scales='free')


  


d.summary<-d.params %>% group_by(Parameter,Item, Prevalence) %>%
  summarise(MAP = estimate_mode(Response),
            credHi = HPDhi(Response),
            credLo = HPDlo(Response))


ggplot(data=d.summary, aes(x=Parameter, y = MAP))+
  geom_bar(stat='identity', position=position_dodge())+
  geom_errorbar(aes(ymin=credLo, ymax=credHi))+
  facet_grid(Prevalence~Item, scales='free')


#d.out <- d.summary %>% filter(Prevalence == 'gamma')

#write.csv(d.out, file='~/Documents/research/generics/manuscript/model-results/asym-prior-byItem-gammaCIs.csv')

```

Reconstruct prevalence priors


```{r}
shape1 = function(gamma,delta){return (gamma * delta)}
shape2= function(gamma,delta){return ((1-gamma) * delta)}

d.samples<-data.frame()


for (i in 1:1000){

  d.samp<-d.params %>%
    group_by(Parameter,Item, Prevalence) %>%
    sample_n(1) %>%
    ungroup() %>%
    spread(Prevalence, Response) %>%
    mutate(alpha = shape1(gamma,delta),
           beta = shape2(gamma, delta)) %>%
    group_by(Parameter, Item) %>%
    mutate(prev = rbeta(1,alpha,beta),
           hasF = rbinom(1,1,prev)) %>%
    select(-gamma, -delta, -alpha, -beta) %>%
    group_by(Parameter) %>%
    summarise(prevalence = if(hasF[Item=='response0']==0) {0} 
              else {prev[Item=='response1']})
  
    d.samples<-bind_rows(d.samples, d.samp)
  
  if ((i %% 10)==0) { print(i) }
}


d.samples$Parameter<-factor(d.samples$Parameter,
                       levels= c("part",
                                 "vague",
                                 "color",
                                 "accidental_high",
                                 "accidental_low"),
                       labels=c("body_parts",
                                "vague_parts",
                                "color_parts",
                                "common_accidental",
                                "rare_accidental"))

a<-ggplot(d.samples, 
          aes(x=prevalence, color=Parameter, linetype=Parameter))+
  geom_density(size=1.3)+
  scale_color_brewer(palette='Set1')+
  xlab("Prevalence")+
  ylab("Posterior density")+
 # theme_black()+
 # facet_grid(Parameter~., scales='free')+
  theme(legend.position=c(0.7,0.65),
        strip.text.y=element_text(angle=0))+
  guides(fill=F)

b<-ggplot(d.samples %>% filter(!(prevalence==0)), 
          aes(x=prevalence, color=Parameter, linetype=Parameter))+
  geom_density(size=1.3)+
  scale_color_brewer(palette='Set1')+
  scale_x_continuous(limits=c(0,1),breaks=c(0.25,0.5,0.75,1))+
  xlab("Prevalence")+
  ylab("Posterior density")+
 # theme_black()+
  guides(color=F, linetype=F)+
  #facet_grid(Parameter~., scales='free')+
  theme(strip.text.y=element_text(angle=0))#+
 # theme(legend.position=c(0.7,0.65))

c<-arrangeGrob(a,b,nrow=1)

ggsave(c,file='~/Documents/research/generics/manuscript/figures/prior2_prevalenceprior-50kx3.pdf',width=12, height= 4)
# ggsave(a,file='~/Box Sync/talks/esslli-2015-generics/figures/prior2_prevalenceprior-50ka.pdf',width=7, height= 11)
# ggsave(b,file='~/Box Sync/talks/esslli-2015-generics/figures/prior2_prevalenceprior-50kb.pdf',width=7, height= 11)
# ggsave(b,file='~/Box Sync/talks/esslli-2015-generics/figures/prior2_prevalenceprior-50kblegend.pdf',width=5, height= 5)

```
