---
title: "generics-asymmetry"
author: "mht"
date: "June 27, 2015"
output: html_document
---

## Asymmetry 1. Truth conditions vs. Implied prevalence for 3 "property types".


Properties are either: 

+ Color (e.g. red tails)
+ Vague (e.g. soft tails)
+ Accidental (e.g. broken tails)

We expect to replicate the asymmetry for color, and the reverse asymmetry for accidental. 

The prediction for the vague properties are less clear. Participants may construe them as *distinctive*, and thus may be more willing to endorse the generic. At the same time, they may not be as extendable as the color properties. They may pair with accidental in terms of implied prevalence. If this does pan out, this would be a third interesting case.

n = 100
Accept task n = 47
Implied task n = 53

[Experiment here.](http://stanford.edu/~mtessler/generics/experiments/asymmetry/asymmetry-1.html)

```{r helperFunctions}
sem.2AFC <- function(p, n){return(sqrt((p*(1-p))/n))}
avePrevScore <- function(responses,prevalences){
  avePrev<-if (sum(responses)>0){
    sum(responses*prevalences)/sum(responses)
  } else {
    100
  }
  return(avePrev)
}
```

```{r asym1.entry}
d<-read.csv('generics/experiments/turk/asymmetry-1/asymmetry-1-trials.csv')

d.accept<- d %>% filter(trial_type=='truth_conditions')
d.implied<- d %>% filter(trial_type=='implied_prevalence')
```

```{r asym1.truthconditions}
# calculate proportion of "accepts" for each type and prevalence
accept.summary <- d.accept %>%
  mutate(response = as.numeric(response=='Agree')) %>%
  group_by(stim_type, stim_prevalence) %>%
  summarise(prop = mean(response),
            n = length(response)) %>%
  mutate(sterr = sem.2AFC(prop,n))

ggplot(accept.summary,aes(x=factor(stim_prevalence), y= prop, 
                      group=stim_type, color=stim_type))+
  geom_point(position=position_dodge(0.3))+
  geom_line(position=position_dodge(0.3),size=1.5,linetype=2)+
  geom_errorbar(aes(ymin=prop-2*sterr,
                    ymax=prop+2*sterr),
                width=0.1, size=1.5,
                position=position_dodge(0.3))

# calculate average acceptable prevalence for each workerid and type
d.aveAccPrev <- d.accept %>%
  mutate(response = as.numeric(response=='Agree')) %>%
  group_by(workerid, stim_type) %>%
  summarise(prev = avePrevScore(response,stim_prevalence)) %>%
  mutate(type = "accept")


#rs.accept<-glmer(response ~ stim_type*stim_prevalence + (1 +stim_prevalence | workerid), family='binomial', data=d.accept)
$summary(rs.accept)
```

## Item wise truth conditions

```{r}
# calculate average acceptable prevalence for each workerid and type
d.itemAccPrev <- d.accept %>%
  mutate(response = as.numeric(response=='Agree')) %>%
  group_by(stim_type, stim_property) %>%
  summarise(prev = avePrevScore(response,stim_prevalence),
            n = length(response)) %>%
  mutate(type = "accept")

d.itemAccPrev$stim_property <- with(d.itemAccPrev, reorder(stim_property, prev, function(x) -x))
ggplot(d.itemAccPrev, aes(x=stim_property, y = prev, group=stim_type, fill=stim_type))+
  geom_bar(stat='identity', position=position_dodge())+
  #geom_errorbar(aes(ymin = ave-2*sterr, ymax = ave+2*sterr))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1))

range(d.itemAccPrev$prev)


```

```{r asym1.impliedprev}
# calculate average implied prevalence for each workerid and type
d.aveImpPrev <- d.implied %>%
  mutate(response = to.n(response))%>%
  group_by(workerid, stim_type) %>%
  summarise(prev = mean(response),
            semImPrev = sem(response))%>%
  mutate(type = "implied")



d.asymmetry <- bind_rows(d.aveImpPrev,d.aveAccPrev)


asymmetry.summary<- d.asymmetry %>%
  group_by(type,stim_type) %>%
  summarise(avePrev = mean(prev),
            sterr = sem(prev))

ggplot(asymmetry.summary,
       aes(x=stim_type, y = avePrev, fill = type))+
  geom_bar(position = position_dodge(0.7), stat='identity', width = 0.7)+
  geom_errorbar(aes(ymin=avePrev-2*sterr,ymax=avePrev+2*sterr),
                position=position_dodge(0.7), width=0.3)

rs.asymmetry<-lmer(data=d.asymmetry, 
                   prev~ + type*stim_type + (1 | workerid))

summary(rs.asymmetry)
```

## Item effects

```{r}
#head(d.implied)

d.impItems<-d.implied %>%
  filter(!(workerid %in%trouble.makers)) %>%
  group_by(stim_type, stim_property) %>%
  summarise(ave = mean(to.n(response)),
            sterr = sem(to.n(response)),
           n = length(response))

d.impItems$stim_property<-with(d.impItems, reorder(stim_property, ave, function(x) -x))


ggplot(d.impItems, aes(x=stim_property, y = ave, group=stim_type, fill=stim_type))+
  geom_bar(stat='identity', position=position_dodge())+
  geom_errorbar(aes(ymin = ave-2*sterr, ymax = ave+2*sterr))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1))


```

## By subject
```{r}
mean(d.implied$rt)
sd(d.implied$rt)


ggplot(d.implied,aes(x=rt/1000))+
  geom_histogram()+
  xlim(0,10)

  facet_wrap(~workerid)

## some subjects just put 100 for all
d.rt<-d.implied %>% group_by(workerid) %>%
  summarise(meanrt = mean(rt/1000),
            medrt = median(rt/1000),
            sterr = sem(rt/1000))

d.rt$workerid<- with(d.rt, reorder(workerid, medrt, function(x) -x))

ggplot(d.rt, aes(x=workerid, y= medrt))+
  geom_bar(stat='identity', position=position_dodge())+
    geom_errorbar(aes(ymin = medrt-2*sterr, ymax = medrt+2*sterr))

trouble.makers<-d.rt[d.rt$medrt<0,]$workerid
```

# Prior 1

```{r echo=F}
upperFirst <- function(name){
  return (paste(toupper(substr(name, 1, 1)), substr(name, 2, nchar(name)), sep=""))
}

removeS <- function(name.in){
  exceptions = c("Turtles", "Bees", "Horses", "Giraffes","Whales","Beetles","Eagles","Snakes","Moles")
  bluejays =  c("Blue jay","Blue Jay","Bluejay")
  fleas = c("Flea", "Fly")
  name<-removeSpace(name.in)
  last<-substr(name,nchar(name),nchar(name))
  last2<-substr(name,nchar(name)-1,nchar(name))
  if (name%in%exceptions){
    name.singular <- substr(name,1,nchar(name)-1)
  } else if (name%in%bluejays){
    name.singular <- "Bluejay"
  } else if (name%in%fleas){
    name.singular <- "Flea"
  } else if (name=="Wolves") {
    name.singular <- "Wolf"
  } else if (name=='Dolpin') {
    name.singular <- "Dolphin"
  } else if (name=='Giraffs') {
    name.singular <- "Giraffe"
  }  else if (last2=='es') {
    name.singular <- substr(name,1,nchar(name)-2)
  } else if (last=='s') {
    name.singular <- substr(name,1,nchar(name)-1)
  } else {
    name.singular <- name
  }
  
return(name.singular)
}

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

removeSpace <- function(name){
  if (substrRight(name,1)==' ') {
    name.edit <- substr(name,1, nchar(name)-1)
  } else {
    name.edit <- name
  }
  return(name.edit)
}


d<-read.csv('generics/experiments/turk/asymmetry-prior-1/asymmetry-prior-1-trials.csv')



d$animal.parsed<- factor(unlist(Map(removeS, upperFirst(as.character(d$animal)))))

```


# Response histogram

```{r}
ggplot(d, aes(x=prevalence))+geom_histogram(binwidth=5)+ggtitle('binwidth=5')
```

For each subject:

```{r}
ggplot(d, aes(x=prevalence))+
  geom_histogram(binwidth=5)+
  facet_wrap(~workerid)+
  scale_x_continuous(breaks=c(0, 50, 100))

```


# Animal production data

```{r prior.newAnimals, fig.height=25, fig.width=16}

# retrieve novel animals (and count only one instance per subject)
animals.produced<-filter(d,
                         (!(animal.parsed %in% generics.of.interest$animal)&
                            (property_index==0)|(property_index==8)))


animals.produced$animal_parsed<-with(animals.produced, 
                                     reorder(sentence, response, function(x) -x))

sort(table(animals.produced$animal.parsed))[sort(table(animals.produced$animal.parsed))>10]

# ggplot(animals.produced, aes(x=animal.parsed))+
#   geom_histogram()+
#   #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   coord_flip()

```

# Prevalence distributions


## Estimates for each type

```{r}
ggplot(d,aes(x=prevalence, fill=type))+
  geom_histogram(position=position_dodge(), binwidth = 10)

```


```{r prior.estimatesByType, fig.height=15, fig.width=36}

d.tidy<- d %>%
  group_by(type) %>%
```

# Prior 2

```{r prior2}

d<-read.csv('generics/experiments/turk/asymmetry-prior-2/asymmetry-prior-2-trials.csv')

qplot(data=d,x=response0,y=response1)+
  facet_wrap(~stim_type)+
  geom_jitter()

d.tidy <- d %>% 
  select(stim_type,response0,response1,stim_property) %>%
  gather(resp, val, response0,response1)


ggplot(d.tidy, aes(x=val,fill=stim_type))+
  geom_density(position=position_dodge(),alpha=0.5)+
  facet_wrap(~resp, scales='free')

```

## Inferred betas

```{r fbt.prior2.posterior}
p<-read.csv('generics/analysis/FBT-priors/results/expVal_betas_prior2_incrMH10k.csv')
p<-p %>% separate(key, into=c("condition", "response"))
shape1 = function(gamma,delta){return (gamma * delta)}
shape2= function(gamma,delta){return ((1-gamma) * delta)}


p<-p %>%
  group_by(condition,response) %>%
  mutate(a = shape1(gamma,delta),
         b = shape2(gamma, delta))



x <- seq(0, 1, len = 100)
qplot(x, geom = "blank")+
  stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="red", n = length(x),
                    args = list(shape1 = p[[1,"a"]], 
                                shape2 = p[[1,"b"]]))+
  stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="blue", n = length(x),
                    args = list(shape1 = p[[3,"a"]], 
                                shape2 = p[[3,"b"]]))+
    stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="green", n = length(x),
                    args = list(shape1 = p[[5,"a"]], 
                                shape2 = p[[5,"b"]]))+
    stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="orange", n = length(x),
                    args = list(shape1 = p[[7,"a"]], 
                                shape2 = p[[7,"b"]]))



qplot(x, geom = "blank")+
  stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="red", n = length(x),
                    args = list(shape1 = p[[2,"a"]], 
                                shape2 = p[[2,"b"]]))+
  stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="blue", n = length(x),
                    args = list(shape1 = p[[4,"a"]], 
                                shape2 = p[[4,"b"]]))+
    stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="green", n = length(x),
                    args = list(shape1 = p[[6,"a"]], 
                                shape2 = p[[6,"b"]]))+
    stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="orange", n = length(x),
                    args = list(shape1 = p[[8,"a"]], 
                                shape2 = p[[8,"b"]]))

```

Generate prevalence prior distributions

```{r}


p.tidy<- p %>%select(condition,response, a, b) %>%
  gather(key, val, a, b, -condition) %>%
  mutate(var = paste(response,key, sep='')) %>%
  select(-response,-key) %>% 
  spread(var, val) %>%
  rename(a0 = response0a,
         b0 = response0b,
         a1 = response1a,
         b1 = response1b)

generatePrev <- function(a0,b0,a1,b1){
  prev = if (rbetabinom.ab(1,1,a0,b0)) {
      rbeta(1,a1,b1)
    } else {
      rbeta(1,a1,b1)
      #0
    }
  return(prev)
}

d.1<-data.frame(condition = 'accidental',
                prev = replicate(1000,
                        with(p.tidy[1,], generatePrev(a0,b0,a1,b1))))
d.2<-data.frame(condition = 'color',
                prev = replicate(1000,
                        with(p.tidy[2,], generatePrev(a0,b0,a1,b1))))
d.3<-data.frame(condition = 'part',
                prev = replicate(1000,
                        with(p.tidy[3,], generatePrev(a0,b0,a1,b1))))
d.4<-data.frame(condition = 'vague',
                prev = replicate(1000,
                        with(p.tidy[4,], generatePrev(a0,b0,a1,b1))))
d.all<- bind_rows(d.1,d.2,d.3,d.4)

ggplot(d.all, aes(x=prev,fill=condition))+
  geom_histogram()+
  #geom_density()+
  facet_wrap(~condition, scales='free')

```


# Full bayesian analysis of prior elicitation data and truth conditions / implied prevalence data

```{r tfbt}
d<-read.csv("~/Documents/research/generics/models/generics-hashmh1000_prior-incrmh1000.csv")
d<-read.csv("~/Documents/research/generics/models/results/generics-hashmh100_prior3-incrmh1000.csv")


d.params <- d %>% filter(!(Parameter%in%c("truth_conditions", 
                                          "implied_prevalence")))
samples = 100
d.params <- data.frame(Parameter = rep(d.params$Parameter, 
                                       1+samples*d.params$Probability),
                       Response = rep(d.params$Value, 
                                      1+samples*d.params$Probability))

ggplot(d.params, aes(x=Response))+
  geom_histogram()+
  xlim(0,1)


d.pp <- d %>% 
  filter(Parameter%in%c("truth_conditions", 
                                    "implied_prevalence")) %>%
  group_by(Parameter,Item, Prevalence) %>%
  summarise(expectation = sum(Value*Probability))

# truth conditions plot
ggplot(d.pp %>% filter(Parameter=='truth_conditions'),
       aes(x=Prevalence, y = expectation, color=Item))+
  geom_point(position=position_dodge())+
  geom_line(position=position_dodge())


d.aveprev <- 
  bind_rows(d.pp %>%  
                    filter(Parameter=='implied_prevalence') %>%
                    select(-Prevalence),
            d.pp %>%
            filter(Parameter=='truth_conditions') %>%
            group_by(Item) %>%
            mutate(norm_exp = expectation/sum(expectation)) %>%
            summarise(Parameter = "truth_conditions",
                      expectation = sum(Prevalence*norm_exp)/100)) %>%
  rename(type = Parameter,
         stim_type = Item,
         avePrev = expectation) %>%
  mutate(type = factor(type, labels = c("implied", "accept")),
         src = "model",
         avePrev=avePrev*100)

d.modeldata<-bind_rows(d.aveprev, asymmetry.summary%>%mutate(src='data'))


ggplot(d.modeldata, aes(x=stim_type, y=avePrev, fill = type))+
  geom_bar(position=position_dodge(), stat='identity')+
  facet_wrap(~src)
```