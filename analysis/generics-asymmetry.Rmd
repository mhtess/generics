---
title: "generics-asymmetry"
author: "mht"
date: "June 27, 2015"
output: html_document
---

## Asymmetry 1. Truth conditions vs. Implied prevalence for 3 "property types".


Properties are either: 

+ Color (e.g. red tails)
+ Vague (e.g. soft tails)
+ Accidental (e.g. broken tails)

We expect to replicate the asymmetry for color, and the reverse asymmetry for accidental. 

The prediction for the vague properties are less clear. Participants may construe them as *distinctive*, and thus may be more willing to endorse the generic. At the same time, they may not be as extendable as the color properties. They may pair with accidental in terms of implied prevalence. If this does pan out, this would be a third interesting case.

n = 100
Accept task n = 47
Implied task n = 53

[Experiment here.](http://stanford.edu/~mtessler/generics/experiments/asymmetry/asymmetry-1.html)

```{r helperFunctions}
sem.2AFC <- function(p, n){return(sqrt((p*(1-p))/n))}
avePrevScore <- function(responses,prevalences){
  avePrev<-if (sum(responses)>0){
    sum(responses*prevalences)/sum(responses)
  } else {
    100
  }
  return(avePrev)
}
```

```{r asym1.entry}
d<-read.csv('~/Documents/research/generics/experiments/turk/asymmetry-1/asymmetry-1-trials.csv')

d.accept<- d %>% filter(trial_type=='truth_conditions')
d.implied<- d %>% filter(trial_type=='implied_prevalence')


## some subjects just put 100 for all
d.rt<-d.implied %>% group_by(workerid) %>%
  summarise(meanrt = mean(rt/1000),
            medrt = median(rt/1000),
            sterr = sem(rt/1000))

d.rt$workerid<- with(d.rt, reorder(workerid, medrt, function(x) -x))
trouble.makers<-d.rt[d.rt$medrt<0,]$workerid
```

```{r asym1.truthconditions}
# calculate proportion of "accepts" for each type and prevalence
accept.summary <- d.accept %>%
  mutate(response = as.numeric(response=='Agree')) %>%
  group_by(stim_type, stim_prevalence) %>%
  summarise(prop = mean(response),
            n = length(response)) %>%
  mutate(sterr = sem.2AFC(prop,n))

ggplot(accept.summary,aes(x=factor(stim_prevalence), y= prop, 
                      group=stim_type, color=stim_type))+
  geom_point(position=position_dodge(0.3))+
  geom_line(position=position_dodge(0.3),size=1.5,linetype=2)+
  geom_errorbar(aes(ymin=prop-2*sterr,
                    ymax=prop+2*sterr),
                width=0.1, size=1.5,
                position=position_dodge(0.3))

# calculate average acceptable prevalence for each workerid and type
d.aveAccPrev <- d.accept %>%
  mutate(response = as.numeric(response=='Agree')) %>%
  group_by(workerid, stim_type) %>%
  summarise(prev = avePrevScore(response,stim_prevalence)) %>%
  mutate(type = "accept")


#rs.accept<-glmer(response ~ stim_type*stim_prevalence + (1 +stim_prevalence | workerid), family='binomial', data=d.accept)
#summary(rs.accept)
```

## Item wise truth conditions

```{r}
# calculate average acceptable prevalence for each workerid and type
d.itemAccPrev <- d.accept %>%
  mutate(response = as.numeric(response=='Agree')) %>%
  group_by(stim_type, stim_property) %>%
  summarise(prev = avePrevScore(response,stim_prevalence),
            n = length(response)) %>%
  mutate(type = "accept")

d.itemAccPrev$stim_property <- with(d.itemAccPrev, reorder(stim_property, prev, function(x) -x))
ggplot(d.itemAccPrev, aes(x=stim_property, y = prev, group=stim_type, fill=stim_type))+
  geom_bar(stat='identity', position=position_dodge())+
  #geom_errorbar(aes(ymin = ave-2*sterr, ymax = ave+2*sterr))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1))

range(d.itemAccPrev$prev)


```

```{r asym1.impliedprev}
# calculate average implied prevalence for each workerid and type
d.aveImpPrev <- d.implied %>%
  mutate(response = to.n(response))%>%
  group_by(workerid, stim_type) %>%
  summarise(prev = mean(response),
            semImPrev = sem(response))%>%
  mutate(type = "implied")



d.asymmetry <- bind_rows(d.aveImpPrev,d.aveAccPrev)


asymmetry.summary<- d.asymmetry %>%
  group_by(type,stim_type) %>%
  summarise(avePrev = mean(prev),
            sterr = sem(prev))

ggplot(asymmetry.summary,
       aes(x=stim_type, y = avePrev, fill = type))+
  geom_bar(position = position_dodge(0.7), stat='identity', width = 0.7)+
  geom_errorbar(aes(ymin=avePrev-2*sterr,ymax=avePrev+2*sterr),
                position=position_dodge(0.7), width=0.3)

rs.asymmetry<-lmer(data=d.asymmetry, 
                   prev~ + type*stim_type + (1 | workerid))

summary(rs.asymmetry)
```

## Item effects

```{r}
#head(d.implied)

d.impItems<-d.implied %>%
  filter(!(workerid %in%trouble.makers)) %>%
  group_by(stim_type, stim_property) %>%
  summarise(ave = mean(to.n(response)),
            sterr = sem(to.n(response)),
           n = length(response))

d.impItems$stim_property<-with(d.impItems, reorder(stim_property, ave, function(x) -x))


ggplot(d.impItems, aes(x=stim_property, y = ave, group=stim_type, fill=stim_type))+
  geom_bar(stat='identity', position=position_dodge())+
  geom_errorbar(aes(ymin = ave-2*sterr, ymax = ave+2*sterr))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1))





# testing median split on accidental

d.impAcc<-d.impItems %>% filter(stim_type=='accidental')
d.impAcc$medsplit <- 'low'
d.impAcc[median(d.impAcc$ave)<d.impAcc$ave,]$medsplit<-'high'

d.implied.accidental<-d.implied %>% filter(stim_type=='accidental')



d.implied.accidental$medsplit<-'low'
d.implied.accidental[d.implied.accidental$stim_property %in% d.impAcc[d.impAcc$medsplit=='high',]$stim_property,]$medsplit<-'high'


rs1<-lmer(data=d.implied.accidental, response~medsplit + (1 | workerid))
summary(rs1)

d.impSplit1<- d.implied.accidental %>% filter(trial_type=='implied_prevalence') %>%
  group_by(medsplit) %>%
    summarise(ave = mean(to.n(response)),
            sterr = sem(to.n(response)),
           n = length(response))


ggplot(d.impSplit1, aes(x=medsplit, y = ave))+
  geom_bar(stat='identity', position=position_dodge())+
  geom_errorbar(aes(ymin = ave-2*sterr, ymax = ave+2*sterr))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1))

head(d)
head(d.implied.accidental)

d.accidental<-(d %>% filter(stim_type=='accidental'))

d.accidental$medsplit<-'low'
d.accidental[d.accidental$stim_property %in% d.impAcc[d.impAcc$medsplit=='high',]$stim_property,]$medsplit<-'high'
d$stim_type<-as.character(d$stim_type)
d[d$stim_type=='accidental',]$stim_type<-paste(d.accidental$stim_type,d.accidental$medsplit, sep='-')


write.csv(d, file='~/Documents/research/generics/models/data/asymmetry-1-trials-medSplitAccidental.csv', row.names=F)
```

## By subject
```{r}
mean(d.implied$rt)
sd(d.implied$rt)


ggplot(d.implied,aes(x=rt/1000))+
  geom_histogram()+
  xlim(0,10)

  facet_wrap(~workerid)



ggplot(d.rt, aes(x=workerid, y= medrt))+
  geom_bar(stat='identity', position=position_dodge())+
    geom_errorbar(aes(ymin = medrt-2*sterr, ymax = medrt+2*sterr))

```


## From previous experiment

n = 100, just accidental, TC / IP between-subjects

```{r}

d<-read.csv(file = '~/Documents/research//generics//cbg2010-replication/turk/exp14/cbg-exp14-trials.csv')

d.impItems2<-d %>% filter(trial_type=='implied_prevalence') %>%
  group_by(stim_property) %>%
    summarise(ave = mean(to.n(response)),
            sterr = sem(to.n(response)),
           n = length(response))

d.impItems2$stim_property<-with(d.impItems2, reorder(stim_property, ave, function(x) -x))



ggplot(d.impItems2, aes(x=stim_property, y = ave))+
  geom_bar(stat='identity', position=position_dodge())+
  geom_errorbar(aes(ymin = ave-2*sterr, ymax = ave+2*sterr))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1))


# testing median split
d.impItems2$medsplit <- 'low'
d.impItems2[median(d.impItems2$ave)<d.impItems2$ave,]$medsplit<-'high'


d$medsplit<-'low'
d[d$stim_property %in% d.impItems2[d.impItems2$medsplit=='high',]$stim_property,]$medsplit<-'high'


rs2<- lmer(data=d,response ~ medsplit + (1 | workerid))
summary(rs2)

d.impSplit<-d %>% filter(trial_type=='implied_prevalence') %>%
  group_by(medsplit) %>%
    summarise(ave = mean(to.n(response)),
            sterr = sem(to.n(response)),
           n = length(response))


ggplot(d.impSplit, aes(x=medsplit, y = ave))+
  geom_bar(stat='identity', position=position_dodge())+
  geom_errorbar(aes(ymin = ave-2*sterr, ymax = ave+2*sterr))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1))



```

There is a difference between implications of top median and bottom median.


# Prior 1

```{r echo=F}
upperFirst <- function(name){
  return (paste(toupper(substr(name, 1, 1)), substr(name, 2, nchar(name)), sep=""))
}

removeS <- function(name.in){
  exceptions = c("Turtles", "Bees", "Horses", "Giraffes","Whales","Beetles","Eagles","Snakes","Moles")
  bluejays =  c("Blue jay","Blue Jay","Bluejay")
  fleas = c("Flea", "Fly")
  name<-removeSpace(name.in)
  last<-substr(name,nchar(name),nchar(name))
  last2<-substr(name,nchar(name)-1,nchar(name))
  if (name%in%exceptions){
    name.singular <- substr(name,1,nchar(name)-1)
  } else if (name%in%bluejays){
    name.singular <- "Bluejay"
  } else if (name%in%fleas){
    name.singular <- "Flea"
  } else if (name=="Wolves") {
    name.singular <- "Wolf"
  } else if (name=='Dolpin') {
    name.singular <- "Dolphin"
  } else if (name=='Giraffs') {
    name.singular <- "Giraffe"
  }  else if (last2=='es') {
    name.singular <- substr(name,1,nchar(name)-2)
  } else if (last=='s') {
    name.singular <- substr(name,1,nchar(name)-1)
  } else {
    name.singular <- name
  }
  
return(name.singular)
}

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

removeSpace <- function(name){
  if (substrRight(name,1)==' ') {
    name.edit <- substr(name,1, nchar(name)-1)
  } else {
    name.edit <- name
  }
  return(name.edit)
}


d<-read.csv('generics/experiments/turk/asymmetry-prior-1/asymmetry-prior-1-trials.csv')



d$animal.parsed<- factor(unlist(Map(removeS, upperFirst(as.character(d$animal)))))

```


# Response histogram

```{r}
ggplot(d, aes(x=prevalence))+geom_histogram(binwidth=5)+ggtitle('binwidth=5')
```

For each subject:

```{r}
ggplot(d, aes(x=prevalence))+
  geom_histogram(binwidth=5)+
  facet_wrap(~workerid)+
  scale_x_continuous(breaks=c(0, 50, 100))

```


# Animal production data

```{r prior.newAnimals, fig.height=25, fig.width=16}

# retrieve novel animals (and count only one instance per subject)
animals.produced<-filter(d,
                         (!(animal.parsed %in% generics.of.interest$animal)&
                            (property_index==0)|(property_index==8)))


animals.produced$animal_parsed<-with(animals.produced, 
                                     reorder(sentence, response, function(x) -x))

sort(table(animals.produced$animal.parsed))[sort(table(animals.produced$animal.parsed))>10]

# ggplot(animals.produced, aes(x=animal.parsed))+
#   geom_histogram()+
#   #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
#   coord_flip()

```

# Prevalence distributions


## Estimates for each type

```{r}
ggplot(d,aes(x=prevalence, fill=type))+
  geom_histogram(position=position_dodge(), binwidth = 10)

```


```{r prior.estimatesByType, fig.height=15, fig.width=36}

d.tidy<- d %>%
  group_by(type) %>%
```

# Prior 2

```{r prior2}

d<-read.csv('generics/experiments/turk/asymmetry-prior-2/asymmetry-prior-2-trials.csv')

qplot(data=d,x=response0,y=response1)+
  facet_wrap(~stim_type)+
  geom_jitter()

d.tidy <- d %>% 
  select(stim_type,response0,response1,stim_property) %>%
  gather(resp, val, response0,response1)


ggplot(d.tidy, aes(x=val,fill=stim_type))+
  geom_density(position=position_dodge(),alpha=0.5)+
  facet_wrap(~resp, scales='free')

```

## Inferred betas

```{r fbt.prior2.posterior}
p<-read.csv('generics/analysis/FBT-priors/results/expVal_betas_prior2_incrMH10k.csv')
p<-p %>% separate(key, into=c("condition", "response"))
shape1 = function(gamma,delta){return (gamma * delta)}
shape2= function(gamma,delta){return ((1-gamma) * delta)}


p<-p %>%
  group_by(condition,response) %>%
  mutate(a = shape1(gamma,delta),
         b = shape2(gamma, delta))



x <- seq(0, 1, len = 100)
qplot(x, geom = "blank")+
  stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="red", n = length(x),
                    args = list(shape1 = p[[1,"a"]], 
                                shape2 = p[[1,"b"]]))+
  stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="blue", n = length(x),
                    args = list(shape1 = p[[3,"a"]], 
                                shape2 = p[[3,"b"]]))+
    stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="green", n = length(x),
                    args = list(shape1 = p[[5,"a"]], 
                                shape2 = p[[5,"b"]]))+
    stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="orange", n = length(x),
                    args = list(shape1 = p[[7,"a"]], 
                                shape2 = p[[7,"b"]]))



qplot(x, geom = "blank")+
  stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="red", n = length(x),
                    args = list(shape1 = p[[2,"a"]], 
                                shape2 = p[[2,"b"]]))+
  stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="blue", n = length(x),
                    args = list(shape1 = p[[4,"a"]], 
                                shape2 = p[[4,"b"]]))+
    stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="green", n = length(x),
                    args = list(shape1 = p[[6,"a"]], 
                                shape2 = p[[6,"b"]]))+
    stat_function(aes(x = x, y = ..y..), 
                    fun = dbeta, colour="orange", n = length(x),
                    args = list(shape1 = p[[8,"a"]], 
                                shape2 = p[[8,"b"]]))

```

Generate prevalence prior distributions

```{r}


p.tidy<- p %>%select(condition,response, a, b) %>%
  gather(key, val, a, b, -condition) %>%
  mutate(var = paste(response,key, sep='')) %>%
  select(-response,-key) %>% 
  spread(var, val) %>%
  rename(a0 = response0a,
         b0 = response0b,
         a1 = response1a,
         b1 = response1b)

generatePrev <- function(a0,b0,a1,b1){
  prev = if (rbetabinom.ab(1,1,a0,b0)) {
      rbeta(1,a1,b1)
    } else {
      rbeta(1,a1,b1)
      #0
    }
  return(prev)
}

d.1<-data.frame(condition = 'accidental',
                prev = replicate(1000,
                        with(p.tidy[1,], generatePrev(a0,b0,a1,b1))))
d.2<-data.frame(condition = 'color',
                prev = replicate(1000,
                        with(p.tidy[2,], generatePrev(a0,b0,a1,b1))))
d.3<-data.frame(condition = 'part',
                prev = replicate(1000,
                        with(p.tidy[3,], generatePrev(a0,b0,a1,b1))))
d.4<-data.frame(condition = 'vague',
                prev = replicate(1000,
                        with(p.tidy[4,], generatePrev(a0,b0,a1,b1))))
d.all<- bind_rows(d.1,d.2,d.3,d.4)

ggplot(d.all, aes(x=prev,fill=condition))+
  geom_histogram()+
  #geom_density()+
  facet_wrap(~condition, scales='free')

```


# Full bayesian analysis of prior elicitation data and truth conditions / implied prevalence data



### inferred prior from prior elicitation data

```{r priors.fbt}
g<-read.csv("~/Documents/research/generics/models/results/priorERP-incrmh1000_accidental_high.csv")
```


```{r tfbt}
d<-read.csv("~/Documents/research/generics/models/results/generics-hashmh1000_prior-incrmh1000.csv")
d<-read.csv("~/Documents/research/generics/models/results/generics-soWord-soNumber-phi-hashmh1000_prior2-incrmh1000.csv")
d<-read.csv("~/Documents/research/generics/models/results/generics-truthOpt-impliedOpt-phi-hashmh50000_prior2-incrmh1000.csv")
d<-read.csv("~/Documents/research/generics/models/results/generics-truthOpt-impliedOpt-hashmh100_prior2-incrmh1000.csv")

d<-read.csv("~/Documents/research/generics/models/results/generics-priorUncertainty-truthOpt-impliedOpt-nophi-hashmh1000_prior2-incrmh1000.csv")
d<-read.csv("~/Documents/research/generics/models/results/generics-priorUncertainty-phi-hashmh100_asym2-prior4-incrmh1k.csv")



d.params <- d %>% filter(!(Parameter%in%c("truth_conditions", 
                                          "implied_prevalence")))
# 
# d.params<-d.params %>% select(Parameter,Item, Prevalence) %>%
#   rename(Value = Item,
#          Probability = Prevalence) %>%
#   mutate(Value = to.n(Value))
# 

samples = 100
d.params <- data.frame(Parameter = rep(d.params$Parameter, 
                                       1+samples*d.params$Probability),
                       Response = rep(d.params$Value, 
                                      1+samples*d.params$Probability))

ggplot(d.params, aes(x=Response))+
  geom_histogram()+
  facet_wrap(~Parameter)

quantile((d.params %>% filter(Parameter=='truthOptimality'))$Response, 
         probs = c(0.025,0.975))

quantile((d.params %>% filter(Parameter=='impliedOptimality'))$Response, 
         probs = c(0.025,0.975))


d.tasks <- d %>% 
  filter(Parameter%in%c("truth_conditions", 
                                    "implied_prevalence"))

d.tasks <-  data.frame(Parameter = rep(d.tasks$Parameter, 
                                       1+samples*d.tasks$Probability),
                       Item = rep(d.tasks$Item, 
                                       1+samples*d.tasks$Probability),
                       Prevalence = rep(d.tasks$Prevalence, 
                                       1+samples*d.tasks$Probability),
                       Response = rep(d.tasks$Value, 
                                      1+samples*d.tasks$Probability))




d.pp <- d.tasks %>%
  group_by(Parameter,Item, Prevalence) %>%
  summarise(expectation = mean(Response),
            credLow = quantile(Response, probs=0.025),
            credHigh = quantile(Response, probs=0.975))

# truth conditions plot
ggplot(d.pp %>% filter(Parameter=='truth_conditions'),
       aes(x=Prevalence, y = expectation, color=Item))+
  geom_point(position=position_dodge())+
  geom_line(position=position_dodge())


d.aveprev <- 
  bind_rows(d.pp %>%  
                    filter(Parameter=='implied_prevalence') %>%
                    select(-Prevalence),
            d.pp %>%
            filter(Parameter=='truth_conditions') %>%
            group_by(Item) %>%
            mutate(norm_exp = expectation/sum(expectation)) %>%
            summarise(Parameter = "truth_conditions",
                      expectation = sum(Prevalence*norm_exp)/100)) %>%
  rename(type = Parameter,
         stim_type = Item,
         avePrev = expectation) %>%
  mutate(type = factor(type, labels = c("implied", "accept")),
         src = "model",
         avePrev=avePrev*100)

d.modeldata<-bind_rows(d.aveprev, asymmetry.summary%>%mutate(src='data'))

ggplot(d.modeldata, aes(x=stim_type, y=avePrev, fill = type))+
  geom_bar(position=position_dodge(), stat='identity')+
  facet_wrap(~src)

ggplot(d.modeldata %>% filter(type=='implied' & src=='model'),
       aes(x=stim_type, y=avePrev, fill = stim_type))+
  geom_bar(position=position_dodge(), stat='identity')+
  geom_errorbar(position=position_dodge(),
                aes(ymin=100*credLow, ymax = 100*credHigh))

```



## Asymmetry 2.  Implied prevalence for 4-5 "property types".


Properties are either: 

+ Parts (e.g. tails)
+ Color (e.g. red tails)
+ Vague (e.g. soft tails)
+ Accidental (e.g. broken tails) --- 2 types of accidental, to 


[Experiment here.](http://stanford.edu/~mtessler/generics/experiments/asymmetry/asymmetry-2.html)


n = 40 ($0.60)

```{r asym2.entry}
d.implied<-read.csv('~/Documents/research/generics/experiments/turk/asymmetry-2/asymmetry-2-trials.csv')
table(d$stim_property)

d.accept<-read.csv('~/Documents/research/generics/experiments/turk/asymmetry-2/truth-conditions-2-trials.csv')

d<-read.csv('~/Documents/research/generics/models/data/asymmetry-2-trials-medSplitAccidental.csv')


d.accept<- d %>% filter(trial_type=='truth_conditions')
d.implied<- d %>% filter(trial_type=='implied_prevalence')




## some subjects just put 100 for all
d.rt<-d.implied %>% group_by(workerid) %>%
  summarise(meanrt = mean(rt/1000),
            medrt = median(rt/1000),
            sterr = sem(rt/1000))

d.rt$workerid<- with(d.rt, reorder(workerid, medrt, function(x) -x))
trouble.makers<-d.rt[d.rt$medrt<0,]$workerid
```

```{r asym2.truthconditions}
# calculate proportion of "accepts" for each type and prevalence
accept.summary <- d.accept %>%
  mutate(response = as.numeric(response=='Agree')) %>%
  group_by(stim_type, stim_prevalence) %>%
  summarise(prop = mean(response),
            n = length(response)) %>%
  mutate(sterr = sem.2AFC(prop,n))

ggplot(accept.summary,aes(x=factor(stim_prevalence), y= prop, 
                      group=stim_type, color=stim_type))+
  geom_point(position=position_dodge(0.3))+
  geom_line(position=position_dodge(0.3),size=1.5,linetype=2)+
  geom_errorbar(aes(ymin=prop-2*sterr,
                    ymax=prop+2*sterr),
                width=0.1, size=1.5,
                position=position_dodge(0.3))

rs.accept<-glmer(response ~ type*stim_prevalence + (1 | workerid), 
                 family='binomial', data=d.accept)

rs0<-glm(response ~ stim_prevalence, 
                 family='binomial', data=d.accept)

rs1<-glm(response ~  type + stim_prevalence, 
                 family='binomial', data=d.accept)
rs2<-glm(response ~ type*stim_prevalence, 
                 family='binomial', data=d.accept)


summary(rs0)

a0<-anova(rs0, rs1, test='Chisq')
a0

```

## Asymmetry (money plot 2)

```{r asym2.moneyplot}
d.aveImpPrev <- d.implied %>%
  mutate(response = to.n(response))%>%
  group_by(workerid, type) %>%
  summarise(prev = 100*mean(response),
            semImPrev = 100*sem(response))%>%
  mutate(src = "implied")

# calculate average acceptable prevalence for each workerid and type
d.aveAccPrev <- d.accept %>%
  mutate(response = as.numeric(response==1)) %>%
  group_by(workerid, type) %>%
  summarise(prev = avePrevScore(response,stim_prevalence)) %>%
  mutate(src = "accept")



d.asymmetry <- bind_rows(d.aveImpPrev,d.aveAccPrev)


asymmetry.summary<- d.asymmetry %>%
  group_by(src,type) %>%
  summarise(avePrev = mean(prev),
            sterr = sem(prev))


asymmetry.summary$type<-with(asymmetry.summary %>% filter(src=='implied'), 
                             reorder(type, avePrev, function(x) x))


ggplot(asymmetry.summary,
       aes(x=type, y = avePrev, fill = src))+
  geom_bar(position = position_dodge(0.7), stat='identity', width = 0.7)+
  geom_errorbar(aes(ymin=avePrev-2*sterr,ymax=avePrev+2*sterr),
                position=position_dodge(0.7), width=0.3)




## computing standard error across the implied data set (i think this is the correct way to do this)
d.impSummary <- d.implied %>%
  mutate(response = to.n(response))%>%
  group_by(type) %>%
  summarise(aveprev = 100*mean(response),
            sterr = 100*sem(response))%>%
  mutate(src = "implied")

d.accSummary<-d.aveAccPrev %>%
  group_by(type) %>% 
  summarise(aveprev = mean(prev),
            sterr = sem(prev)) %>%
  mutate(src='accept')


d.asymSummary<-bind_rows(d.impSummary, d.accSummary)
d.asymSummary$type<-with(d.asymSummary %>% filter(src=='implied'), 
                             reorder(type, aveprev, function(x) x))

d.asymSummary<-d.asymSummary %>%
  rename(task = src,
         avePrev = aveprev) %>%
  mutate(src = 'data',
         credLow = avePrev - 2*sterr,
         credHigh = avePrev + 2*sterr) %>%
  select(-sterr)

ggplot(d.asymSummary,
       aes(x=type, y = aveprev, fill = src))+
  geom_bar(position = position_dodge(0.7), stat='identity', width = 0.7)+
  geom_errorbar(aes(ymin=aveprev-2*sterr,ymax=aveprev+2*sterr),
                position=position_dodge(0.7), width=0.3)




rs.asymmetry<-lmer(data=d.asymmetry, 
                   prev~-1+ type*src + (1 | workerid))

summary(rs.asymmetry)


rs1<-lmer(data=d.implied, response~ type + (1 + type | workerid) + 
                                                  (1 | stim_property))
summary(rs1)

```


## Item effects

```{r}
#head(d.implied)

d.impItems<-d.implied %>%
 # filter(!(workerid %in%trouble.makers)) %>%
  group_by(stim_type, stim_property) %>%
  summarise(ave = mean(to.n(response)),
            sterr = sem(to.n(response)),
           n = length(response))

d.impItems$stim_property<-with(d.impItems, reorder(stim_property, ave, function(x) -x))


ggplot(d.impItems, aes(x=stim_property, y = ave, group=stim_type, fill=stim_type))+
  geom_bar(stat='identity', position=position_dodge())+
  geom_errorbar(aes(ymin = ave-2*sterr, ymax = ave+2*sterr))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1))





# testing median split on accidental
d.implied[d.implied$stim_type=='disease',]$stim_type<-"accidental"

d.impAcc<-d.impItems %>% filter(stim_type=='accidental' | stim_type=='disease')
d.impAcc$medsplit <- 'low'
d.impAcc[median(d.impAcc$ave)<d.impAcc$ave,]$medsplit<-'high'

d.implied.accidental<-d.implied %>%
  filter(stim_type=='accidental' | stim_type=='disease')



d.implied.accidental$medsplit<-'low'
d.implied.accidental[d.implied.accidental$stim_property %in% 
                       d.impAcc[d.impAcc$medsplit=='high',]$stim_property,]$medsplit<-'high'


rs1<-lmer(data=d.implied.accidental, response~medsplit + (1 | workerid))
summary(rs1)

d.impSplit1<- d.implied.accidental %>% 
  group_by(medsplit) %>%
    summarise(ave = mean(to.n(response)),
            sterr = sem(to.n(response)),
           n = length(response))


ggplot(d.impSplit1, aes(x=medsplit, y = ave))+
  geom_bar(stat='identity', position=position_dodge())+
  geom_errorbar(aes(ymin = ave-2*sterr, ymax = ave+2*sterr))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1))

head(d)
head(d.implied.accidental)

d.accidental<-d.implied %>% 
                 filter(stim_type=='accidental' | stim_type=='disease')

d.accidental$medsplit<-'low'
d.accidental[d.accidental$stim_property %in% d.impAcc[d.impAcc$medsplit=='high',]$stim_property,]$medsplit<-'high'
d$stim_type<-as.character(d$stim_type)


d[(d$stim_type=='accidental' |d$stim_type=='disease'),]$stim_type<-
  paste(d.accidental$stim_type, d.accidental$medsplit, sep='-')


write.csv(d, file='~/Documents/research/generics/models/data/asymmetry-2-trials-medSplitAccidental.csv', row.names=F)
```

## By subject
```{r}
mean(d.implied$rt)
sd(d.implied$rt)


ggplot(d,aes(x=rt/1000))+
  geom_histogram()+
  xlim(0,10)+
  facet_wrap(~workerid)



ggplot(d.rt, aes(x=workerid, y= medrt))+
  geom_bar(stat='identity', position=position_dodge())+
    geom_errorbar(aes(ymin = medrt-2*sterr, ymax = medrt+2*sterr))


ggplot(d, aes(x=response))+
  geom_histogram()+
  xlim(0,1)+
  facet_wrap(~workerid)

```



```{r asym1.impliedprev}
# calculate average implied prevalence for each workerid and type
d.aveImpPrev <- d %>%
  mutate(response = to.n(response))%>%
  group_by(stim_type) %>%
  summarise(prev = mean(response),
            semImPrev = sem(response))%>%
  mutate(type = "implied")


asymmetry.summary<- d.aveImpPrev %>%
  group_by(type,stim_type) %>%
  summarise(avePrev = mean(prev),
            sterr = sem(prev))

ggplot(d.aveImpPrev,
       aes(x=stim_type, y = prev, fill = type))+
  geom_bar(position = position_dodge(0.7), stat='identity', width = 0.7)+
  geom_errorbar(aes(ymin=prev-2*semImPrev,ymax=prev+2*semImPrev),
                position=position_dodge(0.7), width=0.3)

rs.asymmetry<-lmer(data=d.asymmetry, 
                   prev~ + type*stim_type + (1 | workerid))

summary(rs.asymmetry)
```


# Prior 4

(paired with asymmetry 2)

```{r prior2}

d<-read.csv('generics/experiments/turk/asymmetry-prior-4/asymmetry-prior-4-trials.csv')


d.tidy <- d %>% 
  select(stim_type,response0,response1,stim_property) %>%
  gather(resp, val, response0,response1)



table(d$stim_property)

qplot(data=d,x=response0,y=response1)+
  facet_wrap(~stim_type)+
  geom_jitter()


ggplot(d.tidy, aes(x=val,fill=stim_type))+
  geom_density(position=position_dodge(),alpha=0.5)+
  facet_wrap(~resp, scales='free')

ggplot(d.tidy, aes(x=val,fill=stim_type))+
  geom_density(position=position_dodge(),alpha=0.5)+
  facet_grid(stim_type~resp, scales='free')



```

### split into accidental hi / lo

```{r}
head(d.tidy)
d.item<-d.tidy %>% 
  group_by(stim_type, stim_property, resp) %>%
  summarise(mean_response = mean(val),
            sterr = sem(val)) %>%
  mutate(ciLow = mean_response - 2*sterr,
         ciHigh = mean_response + 2*sterr)


View(d.item[order(d.item$mean_response, decreasing=T),] %>% filter(resp=='response0'))

d.acc<-d.item %>% filter((stim_type=='accidental' | stim_type=='disease')
                        & resp=='response1')



d.acc$stim_property<-with(d.acc, 
                 reorder(stim_property, mean_response, function(x) -x))


ggplot(d.acc, aes(x=stim_property, y = mean_response))+
  geom_bar(stat='identity')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1)) 


acc.low<-d.acc[order(d.acc$mean_response),]$stim_property[1:8]
acc.hi<-d.acc[order(d.acc$mean_response),]$stim_property[9:16]

d$type<-as.character(d$stim_type)

d[(d$stim_property %in% acc.hi),]$type <- "accidental_high"
d[(d$stim_property %in% acc.low),]$type <- "accidental_low"

write.csv(d,file='~/Documents/research/generics/models/data/asymmetry-prior-4splitAccidental-trials.csv', row.names=F)

d<-read.csv('~/Documents/research/generics/experiments/turk/asymmetry-2/asymmetry-2-trials.csv')
d$type<-as.character(d$stim_type)
d[(d$stim_property %in% acc.hi),]$type <- "accidental_high"
d[(d$stim_property %in% acc.low),]$type <- "accidental_low"


write.csv(d, file='~/Documents/research/generics/models/data/asymmetry-2-trials-medSplitAccidental.csv', row.names=F)


d.aveImpPrev <- d %>%
  mutate(response = to.n(response))%>%
  group_by(type) %>%
  summarise(prev = mean(response),
            semImPrev = sem(response))


ggplot(d.aveImpPrev,
       aes(x=type, y = prev, fill = type))+
  geom_bar(position = position_dodge(0.7), stat='identity', width = 0.7)+
  geom_errorbar(aes(ymin=prev-2*semImPrev,ymax=prev+2*semImPrev),
                position=position_dodge(0.7), width=0.3)

rs.implications<-lmer(data=d, 
                   response~ type + (1 | workerid))

summary(rs.implications)

```

### FBT Priors

```{r priors2.FBT}
d<-read.csv("~/Documents/research/generics/analysis/FBT-priors/results/priors4_betas_byItem_incrMH10000.csv")
d<-read.csv("~/Documents/research/generics/analysis/FBT-priors/results/priors4_betas_byType_incrMH50000.csv")
d.tidy <- d %>% 
  gather(Parameter, Value, Gamma, Delta)

samples = 50000

d.params<-data.frame(Item = rep(d.tidy$Item, 
                               1+samples*d.tidy$Probability),
                Question = rep(d.tidy$Question, 
                               1+samples*d.tidy$Probability),
                Parameter = rep(d.tidy$Parameter, 
                                1+samples*d.tidy$Probability),
                Response = rep(d.tidy$Value, 
                               1+samples*d.tidy$Probability))

fmt <- function(){
    f <- function(x) as.character(round(x,2))
    f
}
d.params$Item<- factor(d.params$Item, levels=c("accidental_low",
                                               "accidental_high",
                                               "color",
                                               "vague",
                                               "part"),
                       labels=c("rare_accidental",
                                "common_accidental",
                                "color_parts",
                                "vague_parts",
                                "body_parts"))




d.delta <- d.params %>% filter(Parameter=='Delta')
d.gamma <- d.params %>% filter(Parameter=='Gamma')
d.gamma$Question<-factor(d.gammma$Question, 
                          levels=c("response0", "response1"),
       labels=c("gamma[between]","gamma[within]"))


ggplot(d.gamma %>% filter(Question=='gamma[between]'), 
       aes(x=Response))+
  geom_histogram(binwidth=0.01,
                 aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]))+
  #geom_density(adjust=2.5)+
  facet_grid(Question~Item, labeller = label_parsed)+
  #facet_wrap(~Item)+
  scale_x_continuous(limits=c(0,1),labels = fmt())+
    theme(strip.text.y = element_text(angle = 0))+
  xlab("Value")+
  ylab("Probability")

ggsave(file='~/Documents/research/generics/manuscript/figures/prior2_gamma-between-posterior-50k.pdf', width=12, height = 3)


d.delta$Question<-factor(d.delta$Question, 
                          levels=c("response0", "response1"),
       labels=c("delta[between]","delta[within]"))


ggplot(d.delta, 
       aes(x=Response))+
  geom_histogram(
                 aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]))+
  #geom_density(adjust=2.5)+
  facet_grid(Question~Item, labeller = label_parsed)+
  #facet_wrap(~Item)+
  scale_x_continuous(limits=c(0,5),labels = fmt())+
    theme(strip.text.y = element_text(angle = 0))+
  xlab("Value")+
  ylab("Probability")

ggsave(file='~/Documents/research/generics/manuscript/figures/prior2_delta-posterior-50k.pdf', width=12, height = 3)

```

Posterior predictive (prevalence prior distribution)
```{r prior2.fbt.prevalenceprior}
d.samples<-data.frame()
for (i in 1:1000){

  d.samp<-d.params %>%
    group_by(Item,Question, Parameter) %>%
    sample_n(1) %>%
    ungroup() %>%
    spread(Parameter, Response) %>%
    mutate(alph = shape1(Gamma,Delta),
           bet = shape2(Gamma, Delta))%>%
    group_by(Item, Question) %>%
    mutate(prev = rbeta(1,alph,bet),
           hasF = rbinom(1,1,prev)) %>%
    select(-Gamma, -Delta, -alph, -bet) %>%
    group_by(Item) %>%
    summarise(prevalence = if(hasF[Question=='response0']==0) {0} 
              else {prev[Question=='response1']})
  
  d.samples<-bind_rows(d.samples, d.samp)
}

ggplot(d.samples, aes(x=prevalence))+
  geom_histogram()+
  facet_wrap(~Item)

d.samples$Item<-factor(d.samples$Item,
                       levels=c("body_parts",
                                "vague_parts",
                                "color_parts",
                                "common_accidental",
                                "rare_accidental"))

a<-ggplot(d.samples, 
          aes(x=prevalence, color=Item))+
  geom_density(size=1.1)+
  scale_color_brewer(palette='Set1')+
  xlab("Prevalence")+
  ylab("Posterior density")+
  theme(legend.position=c(0.7,0.65))

b<-ggplot(d.samples %>% filter(!(prevalence==0)), 
          aes(x=prevalence, color=Item))+
  geom_density(size=1.3, linetype =1 )+
  scale_color_brewer(palette='Set1')+
  scale_x_continuous(limits=c(0,1),breaks=c(0.25,0.5,0.75,1))+
  xlab("Prevalence")+
  ylab("Posterior density")+
  guides(color=F)

c<-arrangeGrob(a,b,nrow=1)

ggsave(c,file='~/Documents/research/generics/manuscript/figures/prior2_prevalenceprior-50k.pdf',width=12, height= 4)
```


By item analysis

```{r prior2.fbt.byItem}
d.par<- d.params %>%
  group_by(Item, Question, Parameter) %>%
  summarise(Value = mean(Response),
            CiHi = quantile(Response, probs = 0.975),
            CiLo = quantile(Response, probs = 0.025)) %>%
  filter(Question=='response1' & Parameter == 'Gamma')


# add category labels
d.prior<-read.csv('generics/experiments/turk/asymmetry-prior-4/asymmetry-prior-4-trials.csv')
d.prior<-d.prior %>% select(stim_property, stim_type) %>%
  rename(Item = stim_property,
         Type = stim_type)
d.par<-left_join(d.par, unique(d.prior))


d.par$Item<-with(d.par, 
                 reorder(Item, Value, function(x) -x))





ggplot(d.par, aes(x=Item, y = Value, fill=Type))+
  geom_bar(stat='identity')+
  geom_errorbar(aes(ymin = CiLo, ymax = CiHi))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1)) 


# compare median split to unprocessed prior elicitation data

d.par.acc<-d.par %>% filter((Type=='accidental' | Type=='disease'))

acc.fbt.low<-d.par.acc[order(d.par.acc$Value),]$Item[1:8]
acc.fbt.hi<-d.par.acc[order(d.par.acc$Value),]$Item[9:16]
```


Append median split data to (1) prior elicitation csv; (2) implied / truth conditions csv

```{r append.mediansplit}
acc.low
acc.hi
acc.fbt.low
acc.fbt.hi

d.prior<-read.csv('generics/experiments/turk/asymmetry-prior-4/asymmetry-prior-4-trials.csv')

d.prior$type<-as.character(d.prior$stim_type)

d.prior[(d.prior$stim_property %in% acc.hi),]$type <- "accidental_high"
d.prior[(d.prior$stim_property %in% acc.low),]$type <- "accidental_low"

write.csv(d.prior,file='~/Documents/research/generics/models/data/asymmetry-prior-4splitAccidental-trials.csv', row.names=F)

d.prior[(d.prior$stim_property %in% acc.fbt.hi),]$type <- "accidental_high"
d.prior[(d.prior$stim_property %in% acc.fbt.low),]$type <- "accidental_low"

write.csv(d.prior,file='~/Documents/research/generics/models/data/asymmetry-prior-4splitAccidentalFBT-trials.csv', row.names=F)


d<-read.csv('~/Documents/research/generics/experiments/turk/asymmetry-2/asymmetry-2-trials.csv')
d$stim_prevalence<-NA

d.accept<-read.csv('~/Documents/research/generics/experiments/turk/asymmetry-2/truth-conditions-2-trials.csv')

e<-bind_rows(d,
             d.accept %>%
              rowwise() %>%
              mutate(response = switch(response, Agree = 1, Disagree = 0)))


e$type<-as.character(e$stim_type)


# using median split based on average prevalence reported in question 1
e[(e$stim_property %in% acc.hi),]$type <- "accidental_high"
e[(e$stim_property %in% acc.low),]$type <- "accidental_low"


write.csv(e, file='~/Documents/research/generics/models/data/asymmetry-2-trials-medSplitAccidental.csv', row.names=F)


## using median split based on inferred gammas
e[(e$stim_property %in% acc.fbt.hi),]$type <- "accidental_high"
e[(e$stim_property %in% acc.fbt.low),]$type <- "accidental_low"

write.csv(e, file='~/Documents/research/generics/models/data/asymmetry-2-trials-medSplitAccidentalFBT.csv', row.names=F)

```


FBT on prior elicitation and asymmetry data. Posterior over parameters and posterior predictive.


```{r tfbt.2}
# d<-read.csv("~/Documents/research/generics/models/results/generics-priorUncertainty-hashmh1000_asym2-prior4-incrmh10k.csv")
# 
# d<-read.csv("~/Documents/research/generics/models/results/generics-priorUncertainty-3opts-phi-hashmh10000_asym2-prior4-incrmh10k.csv")
# 
# 
# d<-read.csv("~/Documents/research/generics/models/results/generics-priorUncertainty-2opts-phi-hashmh10000_asym2-prior4-incrmh10k.csv")
# 
# d<-read.csv("~/Documents/research/generics/models/results/generics-priorUncertainty-3opts-phi-hashmh10000_asym2-prior4-incrmh10k.csv")
# 
# d<-read.csv("~/Documents/research/generics/models/results/generics-priorUncertainty-4opts-phi-hashmh75000_asym2-prior4-incrmh10k.csv")
# 

samples = 100000
paramsetups = "2opts-phi"

d<-read.csv(paste("~/Documents/research/generics/models/results/generics-priorUncertainty-",paramsetups,"-hashmh",
                  sprintf("%1.f",samples),"_asym2-prior4-incrmh10k.csv",sep=''))

d.params <- d %>% filter(!(Parameter%in%c("truth_conditions", 
                                          "implied_prevalence")))
# 
# d.params<-d.params %>% select(Parameter,Item, Prevalence) %>%
#   rename(Value = Item,
#          Probability = Prevalence) %>%
#   mutate(Value = to.n(Value))
# 

d.params <- data.frame(Parameter = rep(d.params$Parameter, 
                                       1+samples*d.params$Probability),
                       Response = rep(d.params$Value, 
                                      1+samples*d.params$Probability))

ggplot(d.params %>%filter(Parameter=='phi'), aes(x=Response))+
  geom_histogram(aes(y=..count../sum(..count..)), binwidth=0.01)+
  xlim(0,1)+
  xlab(expression(phi))+
  ylab("Posterior probability")

ggsave(file=paste('~/Documents/research/generics/manuscript/figures/asym-phi-',paramsetups,'-',samples/1000,'k.pdf',sep=''))

d.opt <- d.params %>% filter((Parameter=='truthOptimality1') | 
                               (Parameter=='impliedOptimality1'))

d.opt$Parameter<- factor(d.opt$Parameter, 
                         levels=c("truthOptimality1",
                                  "impliedOptimality1"),
                         labels=c("lambda[truth_conditions]",
                                  "lambda[implied_prevalence]"))

ggplot(d.opt, aes(x=Response))+
  geom_histogram(aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]))+
  facet_grid(.~Parameter,scales='free', labeller = label_parsed)+
  xlim(0,20)+
  ylab("Posterior probability")+
  xlab("Value")

ggsave(file=paste('~/Documents/research/generics/manuscript/figures/asym-lambdas-',paramsetups,'-',samples/1000,'k.pdf',sep=''))


ggsave(file=paste('~/Documents/research/generics/manuscript/figures/asym-params-',paramsetups,'-',samples/1000,'k.pdf',sep=''))


quantile((d.params %>% filter(Parameter=='truthOptimality1'))$Response, 
         probs = c(0.025,0.975))

quantile((d.params %>% filter(Parameter=='impliedOptimality1'))$Response, 
         probs = c(0.025,0.975))

quantile((d.params %>% filter(Parameter=='truthOptimality2'))$Response, 
         probs = c(0.025,0.975))

quantile((d.params %>% filter(Parameter=='impliedOptimality2'))$Response, 
         probs = c(0.025,0.975))

quantile((d.params %>% filter(Parameter=='phi'))$Response, 
         probs = c(0.025,0.975))


d.tasks <- d %>% 
  filter(Parameter%in%c("truth_conditions", 
                                    "implied_prevalence"))

d.tasks <-  data.frame(Parameter = rep(d.tasks$Parameter, 
                                       1+samples*d.tasks$Probability),
                       Item = rep(d.tasks$Item, 
                                       1+samples*d.tasks$Probability),
                       Prevalence = rep(d.tasks$Prevalence, 
                                       1+samples*d.tasks$Probability),
                       Response = rep(d.tasks$Value, 
                                      1+samples*d.tasks$Probability))




d.pp <- d.tasks %>%
  group_by(Parameter,Item, Prevalence) %>%
  summarise(expectation = mean(Response),
            credLow = quantile(Response, probs=0.025),
            credHigh = quantile(Response, probs=0.975))

# # truth conditions plot
# ggplot(d.pp %>% filter(Parameter=='truth_conditions'),
#        aes(x=Prevalence, y = expectation, color=Item))+
#   geom_point(position=position_dodge())+
#   geom_line(position=position_dodge())
# 

d.aveprev <- 
  bind_rows(d.pp %>%  
                    filter(Parameter=='implied_prevalence') %>%
                    select(-Prevalence),
            d.pp %>%
            filter(Parameter=='truth_conditions') %>%
            group_by(Item) %>%
            mutate(norm_exp = expectation/sum(expectation)) %>%
            summarise(Parameter = "truth_conditions",
                      expectation = sum(Prevalence*norm_exp)/100)) %>%
  rename(
         type = Item,
         avePrev = expectation) %>%
  mutate(task = factor(Parameter, labels = c("implied", "accept")),
         src = "model",
         avePrev=avePrev*100,
         credLow = credLow*100,
         credHigh = credHigh*100) %>%
  select(-Parameter)



# d.modeldata<-bind_rows(d.aveprev, d.asymSummary)
# 
# ggplot(d.modeldata, aes(x=type, y=avePrev, fill = task))+
#   geom_bar(position=position_dodge(), stat='identity')+
#   geom_errorbar(position=position_dodge(),
#                 aes(ymin=credLow, ymax = credHigh))+
#   facet_wrap(~src)
# 
# ggplot(d.modeldata %>% filter(type=='implied' & src=='model'),
#        aes(x=stim_type, y=avePrev, fill = stim_type))+
#   geom_bar(position=position_dodge(), stat='identity')+
#   geom_errorbar(position=position_dodge(),
#                 aes(ymin=credLow, ymax = credHigh))

```



 Simulate subjects for truth conditions task
 
```{r asym2.fbt.tc.bootstrap}


d.tc <- d.tasks %>% filter(Parameter =='truth_conditions')
d.bootstrap <- data.frame()

for (i in 1:100){
  d.simulsamp <- data.frame()
  for (j in 1:40){
    d.subj<- d.tc %>% 
      group_by(Item, Prevalence) %>%
      sample_n(1) %>%
      mutate(Outcome = rbinom(1,1,Response)) %>%
      group_by(Item) %>%
      summarise(avePrev = avePrevScore(Outcome, Prevalence))
    d.simulsamp <- bind_rows(d.simulsamp, d.subj)
  }
  d.groupmean<-d.simulsamp %>% group_by(Item) %>%
    summarise(group_mean = mean(avePrev))
  
  d.bootstrap<- bind_rows(d.bootstrap, d.groupmean)
  print(i)
}


d.simulsubj.stats <- d.bootstrap %>%
  group_by(Item) %>%
  summarise(expectation = mean(group_mean),
            credLow = quantile(group_mean, probs=0.025),
            credHigh = quantile(group_mean, probs=0.975)) %>%
  rename(avePrev = expectation) %>%
  mutate(task = 'accept',
         src = 'model',
         type = Item) %>%
  select(-Item)

d.aveprev<-bind_rows(d.aveprev %>% filter(task=='implied'),
          d.simulsubj.stats)


d.modeldata<-bind_rows(d.aveprev, d.asymSummary)

d.modeldata$type<- with(d.modeldata%>% filter(task=='implied' & src=='data'),
                        reorder(type, avePrev, function(x) -x))


d.modeldata$type<-factor(d.modeldata$type, 
                         labels = c("body parts", "vague parts",
                                    "color parts", "common accidental",
                                    "rare accidental"))

d.modeldata$src<-factor(d.modeldata$src,labels =c("Data", "Model"))

d.modeldata$task<-factor(d.modeldata$task, labels=c("Truth conditions",
                                                    "Implied prevalence"))

ggplot(d.modeldata, aes(x=type, y=avePrev, fill = type, alpha=task))+
  geom_bar(position=position_dodge(0.9),width=0.9,
           color='black',stat='identity')+
  geom_errorbar(position=position_dodge(0.9),
                aes(ymin=credLow, ymax = credHigh),
                width=0.7)+
  scale_alpha_manual(values=c(0.6,1))+
  scale_fill_brewer(palette='Set1')+
  facet_wrap(~src)+
  ylab("Average prevalence")+
  xlab("")+
  guides(fill=F, alpha=guide_legend("Task"))+
    theme(axis.text.x = element_text(angle = 45, hjust = 1,
                                   vjust=1))+
  theme(legend.position='bottom',
        legend.direction='horizontal')

ggsave(file=paste('~/Documents/research/generics/manuscript/figures/asym-data-model-',paramsetups,'-',samples/1000,'k.pdf',sep=''), width=11, height = 6)

(with(d.modeldata %>% select(type, task, src, avePrev) %>% spread(src, avePrev),cor(Data, Model)))^2

```